{"mappings":"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","sources":["src/animation.v2.ts","src/index.ts"],"sourcesContent":["import { BehaviorSubject, filter, forkJoin, map, of, switchMap, tap } from 'rxjs';\n// @ts-ignore\nimport { fromPromise } from 'rxjs/src/internal/observable/innerFrom';\n\nimport {\n  createLine,\n  calcLineLength,\n  generateTornLine,\n  generateSides,\n  generateFigureShape,\n  calcLineAngle,\n  calcPointInPolarSystem,\n} from './math';\nimport CanvasFactory from './canvas/canvas.factory';\nimport { AnimationSettings } from './settings';\nimport { Line, Point } from './types';\n\nexport default class AnimationV2 {\n  private realCanvas = this.canvasFactory.createCanvas(this.width, this.height);\n\n  private readonly leftSideImg = this.document.createElement('img');\n\n  private readonly rightSideImg = this.document.createElement('img');\n\n  private readonly _tick$ = new BehaviorSubject(0);\n\n  private readonly sides = generateSides(this.width, this.height);\n\n  private currentLine!: Line;\n\n  public get tick$() {\n    return this._tick$.asObservable();\n  }\n\n  constructor(\n    private readonly canvasFactory: CanvasFactory,\n    private readonly document: Document,\n    private readonly width: number,\n    private readonly height: number,\n    private readonly offset: Point,\n    private settings: AnimationSettings,\n  ) {\n    const root = document.querySelector('.root');\n\n    root?.appendChild(this.realCanvas.canvas);\n\n    this.setup();\n  }\n\n  public dispatch() {\n    this._tick$.next(this._tick$.value + 1);\n  }\n\n  private setup() {\n    this.realCanvas.fill(this.settings.data.backgroundColor);\n\n    // Generate and save left and right figures every this.settings.data.lineLifeTicksms.\n    this.tick$\n      .pipe(\n        filter((time) => time % this.settings.data.lineLifeTicks === 0),\n        map(() => {\n          this.currentLine = createLine(this.sides, this.offset);\n          const lineLength = calcLineLength(this.currentLine.start, this.currentLine.end);\n\n          const line = generateTornLine(\n            this.currentLine.start,\n            this.currentLine.end,\n            lineLength,\n            parseInt(`${lineLength / 7}`, 10),\n            Math.PI,\n          );\n\n          return generateFigureShape(line, this.width, this.height, this.sides);\n        }),\n        switchMap((figure) =>\n          forkJoin([this.drawPathOnTempCanvas(figure.left), this.drawPathOnTempCanvas(figure.right)]),\n        ),\n        tap(([left, right]) => {\n          this.leftSideImg.src = left;\n          this.rightSideImg.src = right;\n        }),\n      )\n      .subscribe();\n\n    // Draw and animate parts on real canvas.\n    this.tick$\n      .pipe(\n        filter((time) => time % this.settings.data.lineLifeTicks !== 0),\n        map((time) => time % this.settings.data.lineLifeTicks),\n        map((timer) => {\n          const endPointWithoutOffset = {\n            x: this.currentLine.end.x - this.currentLine.start.x,\n            y: this.currentLine.end.y - this.currentLine.start.y,\n          };\n          const lineRadianAngle = calcLineAngle(endPointWithoutOffset);\n          const halfPi = Math.PI / 2;\n\n          return {\n            left: calcPointInPolarSystem(lineRadianAngle - halfPi, timer / this.settings.data.distanceCoefficient),\n            right: calcPointInPolarSystem(lineRadianAngle + halfPi, timer / this.settings.data.distanceCoefficient),\n          };\n        }),\n        switchMap(({ left, right }) =>\n          forkJoin([\n            this.realCanvas.clear(),\n            fromPromise(Promise.resolve().then(() => this.realCanvas.fill(this.settings.data.backgroundColor))),\n            this.realCanvas.drawImage(this.leftSideImg, left),\n            this.realCanvas.drawImage(this.rightSideImg, right),\n          ]),\n        ),\n      )\n      .subscribe();\n  }\n\n  private drawPathOnTempCanvas(path: Point[]) {\n    return of(this.canvasFactory.createCanvas(this.width, this.height)).pipe(\n      switchMap((canvas) =>\n        forkJoin([\n          canvas.drawPath(path, this.settings.data.lineColor, this.settings.data.backgroundColor),\n          canvas.drawImage(this.realCanvas.canvas, { x: 0, y: 0 }),\n        ]).pipe(switchMap(() => canvas.toDataUrl())),\n      ),\n    );\n  }\n}\n","import AnimationV2 from './animation.v2';\nimport { CanvasFactory } from './canvas';\nimport { settings } from './settings';\n\nconst WIDTH = window.innerWidth + 600;\nconst HEIGHT = window.innerHeight + 600;\n\nconst animation = new AnimationV2(new CanvasFactory(document), document, WIDTH, HEIGHT, { x: 600, y: 600 }, settings);\n\n(function render() {\n  animation.dispatch();\n  requestAnimationFrame(render);\n})();\n"],"names":["$5mF43","parcelRequire","$b4e14b6b8da86996$var$WIDTH","window","innerWidth","$b4e14b6b8da86996$var$HEIGHT","innerHeight","$b4e14b6b8da86996$var$animation","tick$","this","_tick$","asObservable","constructor","canvasFactory","document","width","height","offset","settings","realCanvas","createCanvas","leftSideImg","createElement","rightSideImg","$axHCK","BehaviorSubject","sides","$aisEY","generateSides","root","querySelector","appendChild","canvas","setup","dispatch","next","value","fill","data","backgroundColor","pipe","$d6DLj","filter","time","lineLifeTicks","$d4PzE","map","currentLine","createLine","lineLength","calcLineLength","start","end","line","generateTornLine","parseInt","Math","PI","generateFigureShape","$466t7","switchMap","figure","$c6GPX","forkJoin","drawPathOnTempCanvas","left","right","tap","src","subscribe","timer","endPointWithoutOffset","x","y","lineRadianAngle","calcLineAngle","halfPi","calcPointInPolarSystem","distanceCoefficient","clear","$8208i","fromPromise","Promise","resolve","then","drawImage","path","$2b25J","of","drawPath","lineColor","toDataUrl","$ltQS0","CanvasFactory","$b8iNZ","render","requestAnimationFrame"],"version":3,"file":"index.64bddc0d.js.map"}